<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>有料レポートDEVテスト</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue",
          Arial, "Segoe UI", sans-serif;
        background: #fff7f9;
        color: #333;
        margin: 0;
        padding: 24px;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 8px;
      }

      .desc {
        font-size: 13px;
        color: #666;
        margin-bottom: 16px;
        line-height: 1.6;
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr);
        gap: 16px;
      }

      textarea {
        width: 100%;
        min-height: 420px;
        resize: vertical;
        font-family: "SF Mono", Menlo, Consolas, monospace;
        font-size: 12px;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #f3c5d8;
        box-sizing: border-box;
        background: #fff;
      }

      .panel {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        box-sizing: border-box;
      }

      .controls {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 8px;
        margin-bottom: 12px;
      }

      button {
        border: none;
        border-radius: 999px;
        padding: 8px 18px;
        font-size: 13px;
        cursor: pointer;
        background: #ff6b9c;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 3px 8px rgba(255, 107, 156, 0.4);
        transition: transform 0.05s ease-out, box-shadow 0.05s ease-out;
      }

      button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 4px rgba(255, 107, 156, 0.4);
      }

      .status {
        font-size: 12px;
        color: #999;
      }

      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        margin: 0;
        font-family: inherit;
        font-size: 13px;
        line-height: 1.8;
      }

      .sample {
        font-size: 11px;
        color: #999;
        margin-top: 4px;
      }

      @media (max-width: 768px) {
        .layout {
          grid-template-columns: minmax(0, 1fr);
        }
      }
    </style>
  </head>
  <body>
    <h1>有料レポート生成 DEV</h1>
    <p class="desc">
      ここは開発者専用ページです。仙人チャットの内容を人間が要約した
      <code>summaryJson</code> を左に貼り付けて、「レポート生成」を押すと、
      <code>/api/dev-paid-report</code>
      を叩いて本番想定のレポート本文を右側にストリーム表示します。<br />
      JSON の主なキー：<code>title</code>,
      <code>profile_snapshot</code>, <code>summary</code>,
      <code>chapter1_basic_personality</code>〜<code>chapter5_hints</code>,
      <code>closing_message</code>
    </p>

    <div class="layout">
      <!-- 入力側 -->
      <div class="panel">
        <div class="controls">
          <button id="btn-fill-sample" type="button">サンプルJSONを入れる</button>
        </div>
        <textarea
          id="jsonInput"
          placeholder="ここに summaryJson を貼り付けてください（右上ボタンでサンプルを挿入できます）"
        ></textarea>
        <p class="sample">
          ※ JSON としてパースできない場合はフロント側でエラーにします。<br />
          &nbsp;&nbsp;キーが一部欠けていてもバックエンド側で補完する前提です。
        </p>
      </div>

      <!-- 出力側 -->
      <div class="panel">
        <div class="controls">
          <button id="btn-generate" type="button">レポート生成</button>
          <span id="status" class="status">待機中</span>
        </div>
        <pre id="output"></pre>
      </div>
    </div>

    <script>
      (function () {
        const inputEl = document.getElementById("jsonInput");
        const outputEl = document.getElementById("output");
        const statusEl = document.getElementById("status");
        const btnGenerate = document.getElementById("btn-generate");
        const btnSample = document.getElementById("btn-fill-sample");

        // 新仕様に合わせたサンプル summaryJson
        const SAMPLE_JSON = `{
  "title": "げんきさんの恋愛取扱説明書（テスト版）",
  "profile_snapshot": {
    "name": "げんき",
    "age_range": "20〜22",
    "gender": "男性",
    "self_mbti": "ENTJ",
    "self_love_type": "カリスマバランサー",
    "partner_mbti": "ESTP",
    "partner_love_type": "ボス猫",
    "relation_status": "いい感じだがまだ友達寄り",
    "meeting": "友達の友達の飲み会で出会った",
    "known_period": "約1ヶ月",
    "contact_pattern": "2日に1回ほどLINE。返信ペースは相手の方が遅め",
    "worry_one_line": "3回目デートの日程が決まらず、このままフェードアウトされるのではと不安",
    "mental_one_line": "そこまで重くはないが、うまくいけば付き合いたいし、ダメなら別の恋にも切り替えようと思っている"
  },
  "summary": {
    "one_line": "男女としては意識し合っているが、テンポの違いと『友達っぽさ』が混ざって見えにくくなっている恋。",
    "core_theme": "自分は本気で向き合いたいのに、相手のペースが読めずアクセルとブレーキを同時に踏んでしまうこと",
    "stage": "1〜2回目のデートは順調で、お互いそれなりに好意はあるが、まだ友達と恋人のあいだでふわっとしている段階",
    "risk_level": "中"
  },
  "chapter1_basic_personality": {
    "heading": "第1章　げんきさんの基本性格と恋愛のクセ",
    "tagline": "アクセル強めだが、相手の様子を見て一気にブレーキも踏める“攻守どっちも本気型”。",
    "base_traits": "普段のげんきさんは、場の空気を読みながらも、自分なりのゴールや理想像に向かって動くタイプ。",
    "love_pattern": "恋愛モードに入ると、相手のことをちゃんと見ようとする一方で、『自分ばかり真剣に考えていないか？』という不安も同時に走りやすい。",
    "typical_behaviours": "デートの場では友達ノリで盛り上げつつ、LINEでは温度感を細かく観察するクセが出やすい。"
  },
  "chapter2_current_situation": {
    "heading": "第2章　いまの状況と盤面整理",
    "situation_summary": "友達の友達として飲み会で出会い、その後2回のデートまではスムーズに進んできたが、まだ恋愛モードに切り替えきれていない。",
    "relationship_stage": "『恋人未満・友達以上』の手前あたり。",
    "key_events": [
      {
        "label": "出会い",
        "description": "共通の友人を通じた飲み会で初対面。ノリは合い、会話も盛り上がった。"
      },
      {
        "label": "1回目・2回目のデート",
        "description": "会話は弾み、気まずさはほとんどなし。ただし、終始“友達ノリ”寄りで終わった。"
      },
      {
        "label": "3回目デートの日程調整",
        "description": "3回目の候補日をいくつか提案したが、相手の予定が合わず『また都合が合いそうなら連絡する』という形で一旦ストップしている。"
      }
    ]
  },
  "chapter3_emotions": {
    "heading": "第3章　心の中で同時に動いている感情たち",
    "emotions": [
      {
        "name": "ちゃんと向き合いたい期待",
        "description": "せっかく波長の合う相手と出会えたのだから、ここで一度しっかり距離を縮めてみたいという前向きな期待。",
        "triggers": "相手からのLINEが来たときや、楽しかったデートを思い出したとき。",
        "inner_voice_example": "「ここでちゃんとデート重ねたら、普通に付き合える未来もあるよな…」"
      },
      {
        "name": "一人だけ前のめりになってしまう怖さ",
        "description": "もし自分だけが本気で考えていて、相手は軽いノリだったとしたらどうしよう、という怖さ。",
        "triggers": "既読がついてから返信まで時間が空いたときや、曖昧な返事を思い出したとき。",
        "inner_voice_example": "「俺だけがこの恋を真面目に考えてたら、ちょっとダサいよな…」"
      }
    ],
    "internal_conflict_summary": "期待・怖さ・楽観が同時に動き、デート中は友達ノリで笑いを取りに行きつつ、心の中では『もっと踏み込むべきか？』と揺れている。"
  },
  "chapter4_patterns_with_partner": {
    "heading": "第4章　二人のテンポから見える“すれ違いパターン”",
    "self_pattern": "いったん『この人いいかも』と思うと、未来像まで組み立てながら動く一方で、相手の負担を気にして直前でアクセルを緩めてしまう。",
    "partner_pattern": "相手はその場のノリや感覚を大事にしつつ、自分のペースは守るタイプ。予定が詰まると連絡が後回しになりやすい。",
    "interaction_pattern": "「盛り上がるデート→本音は出ない→後から不安がじわじわ」という流れになりやすく、友達ポジションにとどまりやすい。",
    "position_estimation": "脈なしというより、『薄く脈ありはあるがまだ友達寄りの箱』に入っているイメージ。"
  },
  "chapter5_hints": {
    "heading": "第5章　これから進むときのヒント",
    "hints": [
      {
        "title": "友達ノリ7割・ちょい男女3割を混ぜてみる",
        "description": "次に会える場面があれば、軽い褒めや距離の近さなど、小さな“3割の変化”を意識してみる。",
        "caution": "やりすぎると自分でもキャラがブレてしんどくなるので、無理のない範囲で。"
      },
      {
        "title": "日程の話は一度だけ、具体的にボールを投げる",
        "description": "「◯日か◯日なら空いてるけど、どっちかどう？」のように一度だけ具体的に提案し、反応を見る。",
        "caution": "その一球にすべてを賭けず、動かなければ一旦自分の生活を優先する前提で投げると心が軽くなる。"
      }
    ]
  },
  "closing_message": "ここまで自分の気持ちと言葉で向き合っている時点で、もう十分“本気側の人間”なんじゃ。今回の恋がどう転んでも、この経験は次の恋や人付き合いの土台になる。しんどくなったときは『ちゃんと悩めている俺、えらい』と少しだけ自分をねぎらってみるのじゃ。"
}`;

        btnSample.addEventListener("click", () => {
          inputEl.value = SAMPLE_JSON;
        });

        btnGenerate.addEventListener("click", async () => {
          const raw = inputEl.value.trim();
          if (!raw) {
            alert("まず左側に JSON を貼り付けてください。");
            return;
          }

          let parsed;
          try {
            parsed = JSON.parse(raw);
          } catch (e) {
            console.error(e);
            alert("JSON として読み込めません: " + e.message);
            return;
          }

          outputEl.textContent = "";
          statusEl.textContent = "生成中…";

          try {
            const resp = await fetch("/api/dev-paid-report", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(parsed)
            });

            if (!resp.ok || !resp.body) {
              statusEl.textContent = "エラー (" + resp.status + ")";
              return;
            }

            const reader = resp.body.getReader();
            const decoder = new TextDecoder("utf-8");

            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value, { stream: true });
              outputEl.textContent += chunk;
            }

            statusEl.textContent = "完了";
          } catch (err) {
            console.error(err);
            statusEl.textContent = "ネットワークエラー";
          }
        });
      })();
    </script>
  </body>
</html>
